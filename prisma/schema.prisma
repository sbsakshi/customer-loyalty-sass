datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

model Customer {
  customerId  String   @id @map("customer_id")
  name        String
  phoneNumber String   @unique @map("phone_number")
  totalPoints Int      @default(0) @map("total_points")
  isActive    Boolean  @default(true) @map("is_active")
  address     String?
  createdAt   DateTime @default(now()) @map("created_at")

  ledger      TransactionLedger[]
  buckets     PointsBucket[]
  messages    MessageLog[]

  @@map("customers")
}

// IMMUTABLE: Complete transaction history (audit trail)
model TransactionLedger {
  ledgerId        Int      @id @default(autoincrement()) @map("ledger_id")
  customerId      String   @map("customer_id")
  transactionType String   @map("transaction_type") // EARN, REDEEM, EXPIRY
  points          Int      // Positive for EARN, negative for REDEEM/EXPIRY
  balanceAfter    Int      @map("balance_after")
  billAmount      Decimal? @map("bill_amount") // Only for EARN transactions
  description     String?
  createdAt       DateTime @default(now()) @map("created_at")

  customer        Customer @relation(fields: [customerId], references: [customerId])

  @@map("transaction_ledger")
}

// MUTABLE: Active points buckets (deleted when expired/consumed)
model PointsBucket {
  bucketId        Int      @id @default(autoincrement()) @map("bucket_id")
  customerId      String   @map("customer_id")
  pointsEarned    Int      @map("points_earned")     // Original amount earned
  remainingPoints Int      @map("remaining_points")  // Current available points
  expiryDate      DateTime @map("expiry_date")       // When these points expire
  earnedAt        DateTime @default(now()) @map("earned_at")

  customer        Customer @relation(fields: [customerId], references: [customerId])

  @@index([customerId, expiryDate])  // Fast FIFO queries
  @@index([expiryDate])              // Fast expiry lookups
  @@map("points_buckets")
}

model MessageLog {
  logId       Int      @id @default(autoincrement()) @map("log_id")
  customerId  String   @map("customer_id")
  messageType String   @map("message_type")
  content     String
  status      String   @default("SENT")
  sentAt      DateTime @default(now()) @map("sent_at")

  customer    Customer @relation(fields: [customerId], references: [customerId])

  @@map("message_logs")
}
